---
import type { CoverageZone } from '../data/coverageZones';
import { coverageZones } from '../data/coverageZones';
import { SPB_VIEWBOX } from '../data/spbOutline';

interface Props {
  /**
   * Заголовок блока
   */
  title?: string;
  /**
   * Подзаголовок / пояснение
   */
  lead?: string;
  /**
   * id секции (чтобы можно было якорем ссылаться из меню)
   */
  sectionId?: string;
}

const {
  title = 'Зона обслуживания',
  lead = 'Наведите/тапните по зоне на карте, чтобы увидеть стоимость выезда и ориентир по срокам.',
  sectionId = 'coverage'
} = Astro.props;

const vb = SPB_VIEWBOX.split(' ').map((n) => Number(n));
const vbX = vb[0] ?? 0;
const vbY = vb[1] ?? 0;
const vbW = vb[2] ?? 522.329209;
const vbH = vb[3] ?? 345.6;

// Временная отладочная сетка для подбора координат зон (points)
// Выключить: поставь false
const SHOW_GRID = false;
const GRID_MINOR = 25;
const GRID_MAJOR = 100;
const SHOW_GRID_LABELS = true;
const xTicks = Array.from({ length: Math.floor(vbW / GRID_MAJOR) + 1 }, (_, i) => vbX + i * GRID_MAJOR);
const yTicks = Array.from({ length: Math.floor(vbH / GRID_MAJOR) + 1 }, (_, i) => vbY + i * GRID_MAJOR);

// Подсказка координат под курсором (для подбора points)
// Выключить: поставь false
const SHOW_COORDS = false;

const zoneShapes: Array<{
  id: CoverageZone['id'];
  points: string;
}> = [
  // Приморский, Выборгский районы
  { id: 'primorskiy', points: '0,0 150,0 150,45 100,52 0,50' },
  // { id: 'chernyayarechka', points: '100,0 250,0 250,60 200,40 120,50 100,55' },
  { id: 'vyborgskiy', points: '150,0 250,0 300,0 300,138 274,133 272,100 265,75 250,60 200,40 150,45' },
  //Красногвардейский + Калининский районы
  { id: 'krasnogvardeyskiy', points: '300,0 525,0 525,150 374,225 370,215 380,150 381,135 375,125 350,117 325,140 300,138' },
  //Невский район, правый берег
  { id: 'nevskskiy', points: '375,225 525,150 525,350 450,350 440,300 400,265' },
  // Васька и Петроградка + Заячий остров
  { id: 'vasiliostrov', points: '72,120 100,112 145,130 190,160 225,168 225,175 180,200 165,220 160,245 150,250 80,215 60,170' },
  { id: 'petrogradka', points: '75,70 100,55 150,48 215,49 250,64 268,100 270,135 240,157 200,157 150,123 125,115 75,85' },
  // Центр + Адмиралтейский
  { id: 'center', points: '152,277 158,252 165,245 174,215 275,150 325,147 350,127 370,140 371,150 365,190 355,217 358,225 370,244 320,263 300,260 280,255 245,280 152,277' },
  // Московский район
  { id: 'moskovskiy', points: '152,280 243,282 245,345 118,345' },
  // Фрунзенский + Невский район, левый берег
  { id: 'frunzenskiy', points: '245,282 280,259 310,265 328,264 371,246 386,270 425,300 438,322 443,345 247,345' }
];
---

<section class="coverage" id={sectionId}>
  <div class="container">
    <h2 class="section-title">{title}</h2>
    <p class="section-subtitle">{lead}</p>

    <div class="coverage-layout" data-coverage-root>
      <div class="map-wrap">
        <svg
          class="map"
          viewBox={SPB_VIEWBOX}
          role="img"
          aria-label="Карта Санкт‑Петербурга с зонами обслуживания"
        >
          {SHOW_GRID && (
            <defs>
              <pattern
                id="grid-minor"
                width={GRID_MINOR}
                height={GRID_MINOR}
                patternUnits="userSpaceOnUse"
              >
                <path
                  d={`M ${GRID_MINOR} 0 L 0 0 0 ${GRID_MINOR}`}
                  fill="none"
                  stroke="rgba(255,255,255,0.20)"
                  stroke-width="0.6"
                />
              </pattern>
              <pattern
                id="grid-major"
                width={GRID_MAJOR}
                height={GRID_MAJOR}
                patternUnits="userSpaceOnUse"
              >
                <path
                  d={`M ${GRID_MAJOR} 0 L 0 0 0 ${GRID_MAJOR}`}
                  fill="none"
                  stroke="rgba(255,255,255,0.38)"
                  stroke-width="1"
                />
              </pattern>
            </defs>
          )}

          <image
            class="city-map"
            href="/images/map1.webp"
            x={vbX}
            y={vbY}
            width={vbW}
            height={vbH}
            preserveAspectRatio="xMidYMid slice"
          />

          {SHOW_GRID && (
            <g class="grid" pointer-events="none">
              <rect x={vbX} y={vbY} width={vbW} height={vbH} fill="url(#grid-minor)" />
              <rect x={vbX} y={vbY} width={vbW} height={vbH} fill="url(#grid-major)" />

              {SHOW_GRID_LABELS && (
                <g class="grid-labels">
                  {xTicks.map((x) => (
                    <text x={x + 2} y={vbY + 14} class="grid-label">
                      {Math.round(x)}
                    </text>
                  ))}
                  {yTicks.map((y) => (
                    <text x={vbX + 2} y={y + 14} class="grid-label">
                      {Math.round(y)}
                    </text>
                  ))}
                </g>
              )}
            </g>
          )}

          {zoneShapes.map((z) => (
            <polygon
              class="zone"
              data-zone={z.id}
              points={z.points}
              aria-label={`Зона: ${coverageZones.find((x) => x.id === z.id)?.title ?? z.id}`}
            />
          ))}
        </svg>

        {SHOW_COORDS && (
          <div class="coord-tooltip" data-coord-tooltip hidden aria-hidden="true"></div>
        )}
      </div>

      <aside class="panel" aria-live="polite">
        <div class="panel-head">
          <div class="panel-kicker">Выбрана зона</div>
          <div class="panel-title" data-zone-title>—</div>
        </div>

        <dl class="panel-grid">
          <div class="panel-item">
            <dt>Стоимость выезда</dt>
            <dd data-zone-price>—</dd>
          </div>
          <div class="panel-item">
            <dt>Срок прибытия</dt>
            <dd data-zone-eta>—</dd>
          </div>
        </dl>

        <p class="panel-note" data-zone-note hidden></p>

        <p class="panel-attrib">
          <a href="https://openstreetmap.org/copyright" target="_blank" rel="noopener">
            © OpenStreetMap contributors
          </a>
        </p>
      </aside>
    </div>
  </div>

  <script define:vars={{ zones: coverageZones }}>
    const root = document.querySelector('[data-coverage-root]');
    if (!root) return;

    const ZONES = zones;

    const zoneEls = root.querySelectorAll('[data-zone]');
    const svgEl = root.querySelector('svg.map');
    const mapWrap = root.querySelector('.map-wrap');
    const coordEl = root.querySelector('[data-coord-tooltip]');

    const titleEl = root.querySelector('[data-zone-title]');
    const priceEl = root.querySelector('[data-zone-price]');
    const etaEl = root.querySelector('[data-zone-eta]');
    const noteEl = root.querySelector('[data-zone-note]');

    let selectedId = null;

    const byId = (id) => ZONES.find((z) => z.id === id);

    function setActiveVisual(id) {
      zoneEls.forEach((el) => {
        const isActive = el.getAttribute('data-zone') === id;
        el.toggleAttribute('data-active', isActive);
      });
      zoneEls.forEach((el) => {
        const isDim = !!id && el.getAttribute('data-zone') !== id;
        el.toggleAttribute('data-dim', isDim);
      });
    }

    function render(id) {
      const z = id ? byId(id) : undefined;

      if (!titleEl || !priceEl || !etaEl || !noteEl) return;

      if (!z) {
        titleEl.textContent = '—';
        priceEl.textContent = '—';
        etaEl.textContent = '—';
        noteEl.hidden = true;
        noteEl.textContent = '';
        setActiveVisual(null);
        return;
      }

      titleEl.textContent = z.title;
      priceEl.textContent = z.price ?? '—';
      etaEl.textContent = z.eta ?? '—';

      if (z.note) {
        noteEl.hidden = false;
        noteEl.textContent = z.note;
      } else {
        noteEl.hidden = true;
        noteEl.textContent = '';
      }

      setActiveVisual(z.id);
    }

    function select(id) {
      selectedId = id;
      render(id);
    }

    zoneEls.forEach((el) => {
      const id = el.getAttribute('data-zone');
      if (!id) return;

      el.addEventListener('mouseenter', () => render(id));
      el.addEventListener('mouseleave', () => (selectedId ? render(selectedId) : render(null)));
      el.addEventListener('click', () => select(id));
    });

    // Координаты под курсором (в системе viewBox)
    if (svgEl instanceof SVGSVGElement && mapWrap instanceof HTMLElement && coordEl instanceof HTMLElement) {
      const pt = svgEl.createSVGPoint();

      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

      function clientToSvg(clientX, clientY) {
        const ctm = svgEl.getScreenCTM();
        if (!ctm) return null;
        pt.x = clientX;
        pt.y = clientY;
        const p = pt.matrixTransform(ctm.inverse());
        return { x: p.x, y: p.y };
      }

      function updateCoord(e) {
        // не мешаем тачам — координаты нужны для мыши
        if (e.pointerType && e.pointerType !== 'mouse') return;

        const p = clientToSvg(e.clientX, e.clientY);
        if (!p) return;

        coordEl.hidden = false;
        coordEl.textContent = `x: ${p.x.toFixed(1)}, y: ${p.y.toFixed(1)}`;

        const wrapRect = mapWrap.getBoundingClientRect();
        const x = e.clientX - wrapRect.left;
        const y = e.clientY - wrapRect.top;

        // держим тултип в пределах контейнера
        const pad = 10;
        const maxX = wrapRect.width - pad;
        const maxY = wrapRect.height - pad;
        coordEl.style.left = `${clamp(x + 14, pad, maxX)}px`;
        coordEl.style.top = `${clamp(y + 14, pad, maxY)}px`;
      }

      function hideCoord() {
        coordEl.hidden = true;
      }

      svgEl.addEventListener('pointermove', updateCoord);
      svgEl.addEventListener('pointerenter', updateCoord);
      svgEl.addEventListener('pointerleave', hideCoord);
    }

    render(null);
  </script>

  <style>
    .coverage-layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-xl);
      align-items: start;
      margin-top: var(--space-2xl);
    }

    @media (min-width: 900px) {
      .coverage-layout {
        grid-template-columns: 1.2fr 0.8fr;
      }
    }

    .map-wrap {
      display: grid;
      gap: var(--space-lg);
      position: relative;
    }

    .map {
      width: 100%;
      height: auto;
      display: block;
      border-radius: var(--radius-xl);
      overflow: hidden;
    }

    .city-map {
      opacity: 0.95;
      filter: saturate(1.05) contrast(1.05);
    }

    .grid-label {
      font: 12px/1 var(--font-sans);
      fill: rgba(15, 23, 42, 0.8);
      paint-order: stroke;
      stroke: rgba(255, 255, 255, 0.85);
      stroke-width: 3px;
      stroke-linejoin: round;
    }

    .coord-tooltip {
      position: absolute;
      z-index: 5;
      left: 0;
      top: 0;
      pointer-events: none;
      padding: 0.35rem 0.5rem;
      border-radius: 0.5rem;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.55);
      color: rgba(15, 23, 42, 0.9);
      font: 12px/1.1 var(--font-sans);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      white-space: nowrap;
    }

    .zone {
      /* По умолчанию показываем "границы районов", без заливки */
      fill: rgba(99, 102, 241, 0.01); /* почти невидимо, но зона остаётся кликабельной */
      stroke: rgba(99, 102, 241, 0.30);
      stroke-width: 1.25;
      cursor: pointer;
      pointer-events: all;
      transition: transform var(--transition-base), fill var(--transition-base), stroke var(--transition-base);
      transform-origin: center;
    }

    .zone:hover {
      fill: rgba(99, 102, 241, 0.16);
      stroke: rgba(99, 102, 241, 0.55);
    }

    .zone[data-active] {
      fill: rgba(99, 102, 241, 0.22);
      stroke: rgba(99, 102, 241, 0.72);
    }

    .zone[data-dim] {
      fill: rgba(255, 255, 255, 0.8);
      stroke: rgba(255, 255, 255, 0.85);
    }

    .panel {
      background: var(--color-surface);
      backdrop-filter: blur(10px);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: calc(var(--space-3xl));
    }

    /* Mobile performance: убираем blur и sticky (в 1 колонке не нужен) */
    @media (max-width: 767px) {
      .city-map {
        filter: none;
      }

      .panel {
        backdrop-filter: none;
        position: static;
        top: auto;
      }
    }

    .panel-kicker {
      font-size: 0.875rem;
      color: var(--color-text-tertiary);
      margin-bottom: var(--space-xs);
    }

    .panel-title {
      font-weight: var(--font-weight-bold);
      font-size: 1.5rem;
      color: var(--color-text-primary);
      margin-bottom: var(--space-lg);
    }

    .panel-grid {
      display: grid;
      gap: var(--space-md);
      margin: 0;
    }

    .panel-item {
      display: grid;
      gap: var(--space-xs);
      padding: var(--space-md);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      background: rgba(255, 255, 255, 0.6);
    }

    .panel-item dt {
      color: var(--color-text-tertiary);
      font-size: 0.875rem;
      margin: 0;
    }

    .panel-item dd {
      color: var(--color-text-primary);
      font-weight: var(--font-weight-semibold);
      margin: 0;
    }

    .panel-note {
      margin-top: var(--space-md);
      color: var(--color-text-secondary);
      font-size: 0.9375rem;
    }

    .panel-attrib {
      margin-top: var(--space-lg);
      font-size: 0.8125rem;
      color: var(--color-text-tertiary);
    }

    .panel-attrib a {
      color: inherit;
      text-decoration: none;
      border-bottom: 1px dashed rgba(113, 128, 150, 0.45);
    }

    .panel-attrib a:hover {
      color: var(--color-text-secondary);
      border-bottom-color: rgba(113, 128, 150, 0.8);
    }
  </style>
</section>


